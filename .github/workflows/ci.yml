name: CI

on:
  push:
    branches: [develop, staging, main]
  pull_request:
    branches: [develop, staging, main]

env:
  NODE_VERSION: '20'

jobs:
  # =============================================================================
  # Quality Checks: Lint, Type Check, Build
  # Runs on: develop (fast feedback), staging (pre-prod validation), main (deployment gate)
  # =============================================================================
  quality:
    name: Quality Checks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint
        run: npm run lint

      - name: Run TypeScript check
        run: npm run type-check

      - name: Build application
        run: npm run build
        env:
          # Provide dummy env vars for build (not used in CI)
          NEXT_PUBLIC_SUPABASE_URL: https://placeholder.supabase.co
          NEXT_PUBLIC_SUPABASE_ANON_KEY: placeholder-anon-key
          NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY: pk_test_placeholder
          NEXT_PUBLIC_APP_URL: https://www.svolta.app

  # =============================================================================
  # Unit Tests: Vitest
  # Runs on: develop only (fast feedback on code changes)
  # =============================================================================
  test:
    name: Unit Tests
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/develop' || (github.event_name == 'pull_request' && github.base_ref == 'develop')
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run unit tests
        run: npm test -- run

  # =============================================================================
  # Visual Regression Tests: Alignment algorithm validation
  # Runs on: staging only (comprehensive pre-prod validation)
  # =============================================================================
  visual-regression:
    name: Visual Regression Tests
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/staging' || (github.event_name == 'pull_request' && github.base_ref == 'staging')
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install canvas dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libcairo2-dev libpango1.0-dev libjpeg-dev libgif-dev librsvg2-dev

      - name: Generate test fixtures
        run: npm run test:visual:generate

      - name: Run visual regression tests
        run: npm run test:visual

      - name: Upload diff images on failure
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: visual-regression-diffs
          path: tests/visual/diffs/
          retention-days: 7

      - name: Upload test report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: visual-regression-report
          path: tests/visual/report.html
          retention-days: 30

  # =============================================================================
  # Smoke Tests: Critical path tests on develop branch
  # Required to pass before promoting to staging
  # =============================================================================
  smoke:
    name: Smoke Tests
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/develop' || (github.event_name == 'pull_request' && github.base_ref == 'staging')
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Run smoke tests
        run: npm run test:e2e:smoke -- --project=chromium
        env:
          NEXT_PUBLIC_SUPABASE_URL: https://placeholder.supabase.co
          NEXT_PUBLIC_SUPABASE_ANON_KEY: placeholder-anon-key
          NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY: pk_test_placeholder
          NEXT_PUBLIC_APP_URL: http://localhost:3000

      - name: Upload Playwright report
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: smoke-test-report
          path: playwright-report/
          retention-days: 7

  # =============================================================================
  # E2E Tests: Full suite on staging and main branches
  # =============================================================================
  e2e:
    name: E2E Tests
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/staging' || github.ref == 'refs/heads/main'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Run E2E tests
        run: npm run test:e2e -- --project=chromium
        env:
          NEXT_PUBLIC_SUPABASE_URL: https://placeholder.supabase.co
          NEXT_PUBLIC_SUPABASE_ANON_KEY: placeholder-anon-key
          NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY: pk_test_placeholder
          NEXT_PUBLIC_APP_URL: http://localhost:3000

      - name: Upload Playwright report
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: e2e-test-report
          path: playwright-report/
          retention-days: 7

  # =============================================================================
  # Gate Check: Summarizes required checks for branch protection
  # develop: quality + test + smoke
  # staging: quality + visual-regression + e2e
  # main: quality only (tests already validated in staging)
  # =============================================================================
  gate:
    name: Gate Check
    runs-on: ubuntu-latest
    needs: [quality, test, visual-regression, smoke, e2e]
    if: always()
    steps:
      - name: Check required jobs (develop)
        if: github.ref == 'refs/heads/develop' || (github.event_name == 'pull_request' && github.base_ref == 'develop')
        run: |
          if [[ "${{ needs.quality.result }}" != "success" ]] || [[ "${{ needs.test.result }}" != "success" ]] || [[ "${{ needs.smoke.result }}" != "success" ]]; then
            echo "Required checks failed for develop"
            exit 1
          fi
          echo "All required checks passed for develop"

      - name: Check required jobs (staging)
        if: github.ref == 'refs/heads/staging' || (github.event_name == 'pull_request' && github.base_ref == 'staging')
        run: |
          if [[ "${{ needs.quality.result }}" != "success" ]] || [[ "${{ needs.visual-regression.result }}" != "success" ]] || [[ "${{ needs.e2e.result }}" != "success" ]]; then
            echo "Required checks failed for staging"
            exit 1
          fi
          echo "All required checks passed for staging"

      - name: Check required jobs (main)
        if: github.ref == 'refs/heads/main' || (github.event_name == 'pull_request' && github.base_ref == 'main')
        run: |
          if [[ "${{ needs.quality.result }}" != "success" ]]; then
            echo "Required checks failed for main"
            exit 1
          fi
          echo "All required checks passed for main"

